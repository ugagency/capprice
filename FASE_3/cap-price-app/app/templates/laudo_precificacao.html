<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laudo de Precifica√ß√£o - CAP Price</title>
    <style>
        :root {
            --primary-color: #1f2933;
            --secondary-color: #0f766e;
            --success-color: #15803d;
            --warning-color: #f59e0b;
            --danger-color: #b91c1c;
            --light-gray: #f5f5f5;
            --border-color: #e5e7eb;
            --text-muted: #6b7280;
            --text-base: #374151;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.4;
            color: var(--text-base);
            background-color: #f3f4f6;
            margin: 0;
            padding: 12px;
            font-size: 13px;
        }

        .container {
            max-width: 880px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: var(--primary-color);
            color: #ffffff;
            padding: 10px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 11px;
            opacity: 0.85;
        }

        .status-badge {
            background-color: var(--success-color);
            color: #ffffff;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* Main Content */
        .content {
            padding: 18px;
        }

        .laudo-summary {
            background-color: #e0f2fe;
            border-left: 3px solid var(--secondary-color);
            padding: 10px 12px;
            margin-bottom: 16px;
            border-radius: 4px;
        }

        .laudo-summary h3 {
            margin: 0 0 6px 0;
            color: var(--secondary-color);
            font-size: 13px;
            font-weight: 600;
        }

        .laudo-summary p {
            margin: 2px 0;
            font-size: 12px;
        }

        /* Grid System */
        .grid-2 {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            background-color: #ffffff;
        }

        .card-header {
            font-weight: 600;
            font-size: 12px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-header span.icon {
            font-size: 14px;
        }

        .big-number {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .sub-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .center {
            text-align: center;
        }

        /* List Items */
        .info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .info-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .info-list li span.label {
            color: var(--text-muted);
        }

        .info-list li span.value {
            font-weight: 500;
        }

        .info-highlight {
            background-color: #f9fafb;
            font-weight: 600;
            margin-top: 4px;
            border-radius: 3px;
            padding: 4px 6px;
        }

        /* Logistics Viz */
        .route {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--light-gray);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .route-point {
            text-align: center;
            font-size: 11px;
        }

        .route-point strong {
            font-size: 12px;
        }

        .route-arrow {
            font-size: 16px;
            color: var(--secondary-color);
            flex-grow: 1;
            text-align: center;
            border-bottom: 1px dashed #cbd5e1;
            position: relative;
            top: -3px;
            margin: 0 10px;
            padding-bottom: 2px;
        }

        .route-dist {
            display: block;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 12px;
        }

        th,
        td {
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        th {
            background-color: var(--light-gray);
            color: var(--primary-color);
            font-weight: 600;
            font-size: 11px;
        }

        .winner-row {
            background-color: #ecfdf3;
            font-weight: 500;
        }


        /* Footer */
        .footer {
            text-align: center;
            padding: 8px 10px;
            font-size: 10px;
            color: var(--text-muted);
            background-color: #f9fafb;
            border-top: 1px solid var(--border-color);
        }

        .actions {
            text-align: center;
            margin-top: 10px;
        }

        .print-btn {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 6px 16px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }

        .print-btn:hover {
            opacity: 0.9;
        }

        @media print {
            .print-btn {
                display: none;
            }

            body {
                background-color: #ffffff;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <div>
                <h1 class="header-title">Laudo de Precifica√ß√£o</h1>
                <div class="header-subtitle">Plataforma CAP Price</div>
            </div>
            <div class="status-badge">
                Execu√ß√£o: {{ status_execucao or 'N√ÉO INFORMADO' }}
            </div>
        </div>

        <div class="content">
            <!-- Resumo do Laudo (Op√ß√£o vencedora) -->
            <div class="laudo-summary">
                <h3>üèÅ Resultado da An√°lise</h3>
                {% if laudo_texto %}
                <p><strong>Laudo:</strong> {{ laudo_texto }}</p>
                {% endif %}
                {% if motivo %}
                <p><strong>Motivo:</strong> {{ motivo }}</p>
                {% endif %}
                <p class="sub-label">
                    {{ produto }} ‚Ä¢ {{ origem_cidade }}/{{ origem_uf }} ‚Üí {{ destino_cidade }}/{{ destino_uf }} ‚Ä¢
                    Quantidade: {{ quantidade }}
                </p>
            </div>

            <!-- Resumo Financeiro + Dados Log√≠sticos (Op√ß√£o vencedora) -->
            <div class="grid-2">
                <!-- Card Financeiro -->
                <div class="card">
                    <div class="card-header">
                        <span class="icon">üí∞</span>
                        <span>Resumo Financeiro (Op√ß√£o 1 - Vencedora)</span>
                    </div>

                    <div class="center" style="margin-bottom: 8px;">
                        <div class="sub-label">Pre√ßo Final Unit√°rio</div>
                        <div class="big-number">{{ preco_final }}</div>
                    </div>

                    <ul class="info-list">
                        <li>
                            <span class="label">Pre√ßo Net:</span>
                            <span class="value">{{ preco_net }}</span>
                        </li>
                        <li>
                            <span class="label">Frete Unit√°rio:</span>
                            <span class="value">{{ frete }}</span>
                        </li>
                        <li>
                            <span class="label">Impostos:</span>
                            <span class="value">{{ impostos }}</span>
                        </li>
                        <li class="info-highlight">
                            <span class="label">Valor Total ({{ quantidade }} un):</span>
                            <span class="value">{{ valor_total }}</span>
                        </li>
                    </ul>
                </div>

                <!-- Card Log√≠stico -->
                <div class="card">
                    <div class="card-header">
                        <span class="icon">üöõ</span>
                        <span>Dados Log√≠sticos (Op√ß√£o 1 - Vencedora)</span>
                    </div>

                    <div class="route">
                        <div class="route-point">
                            <strong>{{ origem_cidade }}</strong><br>
                            {{ origem_uf }}
                        </div>
                        <div class="route-arrow">
                            ‚ûú
                            <span class="route-dist">{{ distancia_km }}</span>
                        </div>
                        <div class="route-point">
                            <strong>{{ destino_cidade }}</strong><br>
                            {{ destino_uf }}
                        </div>
                    </div>

                    <ul class="info-list">
                        <li>
                            <span class="label">Produto:</span>
                            <span class="value">{{ produto }}</span>
                        </li>
                        <li>
                            <span class="label">Refinaria:</span>
                            <span class="value">{{ refinaria }}</span>
                        </li>
                        <li>
                            <span class="label">Impacto do Frete:</span>
                            <span class="value" style="color: var(--danger-color);">
                                {{ impacto_frete }}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Intelig√™ncia Fiscal (Op√ß√£o vencedora) -->
            <div class="card" style="margin-bottom: 12px;">
                <div class="card-header">
                    <span class="icon">‚öñÔ∏è</span>
                    <span>Intelig√™ncia Fiscal (Op√ß√£o 1 - Vencedora)</span>
                </div>

                <div class="grid-2" style="gap: 14px; margin-bottom: 0;">
                    <div>
                        <ul class="info-list">
                            <li>
                                <span class="label">Situa√ß√£o Fiscal:</span>
                                <span class="value">{{ situacao_fiscal }}</span>
                            </li>
                            <li>
                                <span class="label">Risco:</span>
                                <span class="value">{{ risco_fiscal }}</span>
                            </li>
                            <li>
                                <span class="label">Uso de Saldo:</span>
                                <span class="value">{{ uso_saldo }}</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <div class="sub-label" style="margin-bottom: 4px;">
                            Al√≠quotas Aplicadas
                        </div>
                        {% if aliquotas and aliquotas|length > 0 %}
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            {% for a in aliquotas %}
                            <span style="
                                    background: #f3f4f6;
                                    padding: 3px 8px;
                                    border-radius: 999px;
                                    font-size: 11px;
                                ">
                                {{ a.label }}: {{ a.aliquota }} ({{ a.valor }})
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="sub-label">Sem detalhamento de al√≠quotas informado.</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Altern√¢ncia Condicional: TabelaV vs 3 Melhores Op√ß√µes -->
            {% if exibir_tabela_v %}
            <!-- Pricing - Teste CAP Price (Planilha Interativa) -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <span class="icon">üìä</span>
                    <span>Pricing - Teste CAP Price (Interativo)</span>
                </div>

                <style>
                    .spreadsheet-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 11px;
                        margin: 10px 0;
                    }

                    .spreadsheet-table th,
                    .spreadsheet-table td {
                        border: 1px solid #ccc;
                        padding: 4px 8px;
                    }

                    .section-header {
                        font-weight: bold;
                        text-transform: uppercase;
                        color: white;
                        width: 120px;
                    }

                    .bg-blue {
                        background-color: #d9eaf7;
                        color: #333;
                    }

                    .bg-brown {
                        background-color: #4b2c20;
                        color: white;
                    }

                    .bg-dark-blue {
                        background-color: #003366;
                        color: white;
                    }

                    .bg-red {
                        background-color: #800000;
                        color: white;
                    }

                    .bg-gray {
                        background-color: #f2f2f2;
                    }

                    .spreadsheet-table input {
                        width: 100%;
                        border: 1px solid transparent;
                        background: transparent;
                        text-align: right;
                        font-family: inherit;
                        font-size: inherit;
                        padding: 0;
                        margin: 0;
                    }

                    .spreadsheet-table input:focus {
                        background: white;
                        border-color: #0f766e;
                        outline: none;
                    }

                    .col-label {
                        text-align: left;
                    }

                    .col-value {
                        text-align: right;
                        width: 150px;
                    }

                    .indent-1 {
                        padding-left: 20px !important;
                    }

                    @media print {
                        .spreadsheet-table input {
                            border: none !important;
                        }
                    }
                </style>

                <table class="spreadsheet-table">
                    <!-- PRODUTO -->
                    <tr>
                        <td rowspan="9" class="section-header bg-dark-blue">PRODUTO</td>
                        <td class="col-label bg-blue">Pre√ßo net refinaria por tonelada</td>
                        <td class="col-value bg-blue">
                            <input type="number" id="input-net-unit" value="{{ raw.valor_net_refinaria }}" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-blue">Toneladas</td>
                        <td class="col-value bg-blue">
                            <input type="number" id="input-qtd" value="{{ raw.quantidade }}" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Pre√ßo net refinaria total</td>
                        <td class="col-value bg-red" id="val-net-total">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Al√≠quotas de PIS e Cofins aplic√°veis</td>
                        <td class="col-value bg-red">9,25%</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Al√≠quota de ICMS aplic√°vel</td>
                        <td class="col-value">
                            <input type="number" id="input-aliq-icms-ent" value="{{ raw.aliq_icms_entrada }}"
                                step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Base de c√°lculo de PIS e Cofins</td>
                        <td class="col-value bg-red" id="val-base-entrada">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Base de c√°lculo do ICMS</td>
                        <td class="col-value bg-red" id="val-base-icms-ent">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Valor de PIS e Cofins</td>
                        <td class="col-value" id="val-pis-cofins-ent">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Valor do ICMS</td>
                        <td class="col-value" id="val-icms-ent">R$ 0,00</td>
                    </tr>

                    <!-- FRETE -->
                    <tr>
                        <td rowspan="2" class="section-header bg-brown">FRETE</td>
                        <td class="col-label bg-blue">Pre√ßo cheio por tonelada</td>
                        <td class="col-value bg-blue">
                            <input type="number" id="input-frete-unit" value="{{ raw.vlr_frete_unitario }}" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Pre√ßo cheio total</td>
                        <td class="col-value bg-red" id="val-frete-total">R$ 0,00</td>
                    </tr>

                    <!-- CR√âDITOS -->
                    <tr>
                        <td rowspan="6" class="section-header bg-gray" style="color:#333;">CR√âDITOS E AJUSTES</td>
                        <td class="col-label indent-1">Produto: cr√©ditos ICMS</td>
                        <td class="col-value" id="val-cred-icms-prod">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Produto: cr√©ditos PIS e Cofins</td>
                        <td class="col-value" id="val-cred-pis-prod">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Frete: cr√©ditos ICMS</td>
                        <td class="col-value" id="val-cred-icms-frete">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Frete: cr√©ditos PIS e Cofins</td>
                        <td class="col-value" id="val-cred-pis-frete">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Pre√ßo net total ajustado</td>
                        <td class="col-value bg-red" id="val-net-ajustado">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Pre√ßo net por tonelada ajustado</td>
                        <td class="col-value bg-red" id="val-net-ton-ajustado">R$ 0,00</td>
                    </tr>

                    <!-- COMPOSI√á√ÉO -->
                    <tr>
                        <td rowspan="5" class="section-header bg-dark-blue">COMPOSI√á√ÉO</td>
                        <td class="col-label indent-1">Margem de lucro bruto sobre o custo</td>
                        <td class="col-value">
                            <input type="number" id="input-margem" value="5" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Lucro bruto</td>
                        <td class="col-value bg-red" id="val-lucro-bruto">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-dark-blue indent-1">Pre√ßo l√≠quido de tributos</td>
                        <td class="col-value bg-dark-blue" id="val-preco-liquido">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Frete CIF (Opcional)</td>
                        <td class="col-value">
                            <input type="number" id="input-frete-cif" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Pre√ßo l√≠quido com frete CIF</td>
                        <td class="col-value bg-red" id="val-preco-liq-cif">R$ 0,00</td>
                    </tr>

                    <!-- TRIBUTOS VENDAS -->
                    <tr>
                        <td rowspan="8" class="section-header bg-blue">TRIBUTOS VENDAS</td>
                        <td class="col-label indent-1">Al√≠quota ICMS (Sa√≠da)</td>
                        <td class="col-value">
                            <input type="number" id="input-aliq-icms-saida" value="{{ raw.aliq_icms_saida }}"
                                step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Al√≠quota PIS</td>
                        <td class="col-value">1,65%</td>
                    </tr>
                    <tr>
                        <td class="col-label indent-1">Al√≠quota Cofins</td>
                        <td class="col-value">7,60%</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Base de c√°lculo ICMS / IPI</td>
                        <td class="col-value bg-red" id="val-base-saida">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Base de c√°lculo PIS e Cofins</td>
                        <td class="col-value bg-red" id="val-base-pis-saida">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">ICMS</td>
                        <td class="col-value bg-red" id="val-icms-saida">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">PIS</td>
                        <td class="col-value bg-red" id="val-pis-saida">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td class="col-label bg-red indent-1">Cofins</td>
                        <td class="col-value bg-red" id="val-cofins-saida">R$ 0,00</td>
                    </tr>

                    <!-- FINAL -->
                    <tr>
                        <td class="section-header bg-brown">PRE√áO FINAL</td>
                        <td class="col-label bg-red">Valor total dos produtos</td>
                        <td class="col-value bg-red" id="val-total-final">R$ 0,00</td>
                    </tr>
                </table>

                <script>
                    (function () {
                        const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

                        function update() {
                            // Inputs
                            const netUnit = parseFloat(document.getElementById('input-net-unit').value) || 0;
                            const qtd = parseFloat(document.getElementById('input-qtd').value) || 0;
                            const aliqIcmsEnt = (parseFloat(document.getElementById('input-aliq-icms-ent').value) || 0) / 100;
                            const aliqPisCofinsEnt = 0.0925;
                            const freteUnit = parseFloat(document.getElementById('input-frete-unit').value) || 0;
                            const margem = (parseFloat(document.getElementById('input-margem').value) || 0) / 100;
                            const freteCif = parseFloat(document.getElementById('input-frete-cif').value) || 0;
                            const aliqIcmsSaida = (parseFloat(document.getElementById('input-aliq-icms-saida').value) || 0) / 100;
                            const aliqPisSaida = 0.0165;
                            const aliqCofinsSaida = 0.0760;

                            // 1. Produto
                            const netTotal = netUnit * qtd;
                            const baseEntrada = netTotal / (1 - aliqPisCofinsEnt - aliqIcmsEnt);
                            const pisCofinsEnt = baseEntrada * aliqPisCofinsEnt;
                            const icmsEnt = baseEntrada * aliqIcmsEnt;

                            document.getElementById('val-net-total').innerText = fmt.format(netTotal);
                            document.getElementById('val-base-entrada').innerText = fmt.format(baseEntrada);
                            document.getElementById('val-base-icms-ent').innerText = fmt.format(baseEntrada);
                            document.getElementById('val-pis-cofins-ent').innerText = fmt.format(pisCofinsEnt);
                            document.getElementById('val-icms-ent').innerText = fmt.format(icmsEnt);

                            // 2. Frete
                            const freteTotal = freteUnit * qtd;
                            document.getElementById('val-frete-total').innerText = fmt.format(freteTotal);

                            // 3. Cr√©ditos
                            const credIcmsFrete = freteTotal * 0.12; // Baseado no Excel (R$ 324 p/ 2700)
                            const credPisFrete = freteTotal * 0.0925; // Baseado no Excel
                            const netTotalAjustado = (baseEntrada + freteTotal) - (icmsEnt + pisCofinsEnt + credIcmsFrete + credPisFrete);
                            const netTonAjustado = netTotalAjustado / (qtd || 1);

                            document.getElementById('val-cred-icms-prod').innerText = fmt.format(icmsEnt);
                            document.getElementById('val-cred-pis-prod').innerText = fmt.format(pisCofinsEnt);
                            document.getElementById('val-cred-icms-frete').innerText = fmt.format(credIcmsFrete);
                            document.getElementById('val-cred-pis-frete').innerText = fmt.format(credPisFrete);
                            document.getElementById('val-net-ajustado').innerText = fmt.format(netTotalAjustado);
                            document.getElementById('val-net-ton-ajustado').innerText = fmt.format(netTonAjustado);

                            // 4. Composi√ß√£o
                            const lucroBruto = netTotalAjustado * margem;
                            const precoLiquido = netTotalAjustado + lucroBruto;
                            const precoLiqCif = precoLiquido + freteCif;

                            document.getElementById('val-lucro-bruto').innerText = fmt.format(lucroBruto);
                            document.getElementById('val-preco-liquido').innerText = fmt.format(precoLiquido);
                            document.getElementById('val-preco-liq-cif').innerText = fmt.format(precoLiqCif);

                            // 5. Tributos Vendas
                            const baseSaida = precoLiqCif / (1 - aliqIcmsSaida - aliqPisSaida - aliqCofinsSaida);
                            const icmsSaida = baseSaida * aliqIcmsSaida;
                            const pisSaida = baseSaida * aliqPisSaida;
                            const cofinsSaida = baseSaida * aliqCofinsSaida;

                            document.getElementById('val-base-saida').innerText = fmt.format(baseSaida);
                            document.getElementById('val-base-pis-saida').innerText = fmt.format(baseSaida); // Simplificado
                            document.getElementById('val-icms-saida').innerText = fmt.format(icmsSaida);
                            document.getElementById('val-pis-saida').innerText = fmt.format(pisSaida);
                            document.getElementById('val-cofins-saida').innerText = fmt.format(cofinsSaida);

                            // Final
                            document.getElementById('val-total-final').innerText = fmt.format(baseSaida);
                        }

                        // Attach listeners
                        const inputs = document.querySelectorAll('.spreadsheet-table input');
                        inputs.forEach(input => input.addEventListener('input', update));

                        // Initial run
                        update();
                    })();
                </script>
            </div>
            {% else %}
            <!-- Detalhamento dos top 3 melhore cen√°rios (Melhor Op√ß√£o j√° est√° no topo) -->
            {% if alternativos_detalhados and alternativos_detalhados|length > 0 %}
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <span class="icon">üìä</span>
                    <span>Outras Melhores Op√ß√µes para Compara√ß√£o</span>
                </div>

                {% for alt in alternativos_detalhados %}
                <div class="card" style="margin-bottom: 10px; border-color: var(--border-color); background: #fafafa;">
                    <div class="card-header" style="background: #f1f1f1; font-size: 13px;">
                        <span class="icon">‚≠ê</span>
                        <span>{{ alt.opcao_label }} - {{ alt.refinaria }}</span>
                    </div>

                    <div class="grid-2" style="padding: 10px;">
                        <!-- Bloco financeiro -->
                        <div>
                            <div class="center" style="margin-bottom: 8px;">
                                <div class="sub-label" style="font-size: 10px;">Pre√ßo Final Unit√°rio</div>
                                <div class="big-number" style="font-size: 20px;">{{ alt.preco_final }}</div>
                            </div>

                            <ul class="info-list">
                                <li>
                                    <span class="label">Pre√ßo Net:</span>
                                    <span class="value">{{ alt.preco_net }}</span>
                                </li>
                                <li>
                                    <span class="label">Frete:</span>
                                    <span class="value">{{ alt.frete }}</span>
                                </li>
                                <li>
                                    <span class="label">Impostos:</span>
                                    <span class="value">{{ alt.impostos }}</span>
                                </li>
                                <li class="info-highlight" style="font-size: 11px;">
                                    <span class="label">Valor Total ({{ alt.quantidade }} un):</span>
                                    <span class="value">{{ alt.valor_total }}</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Bloco log√≠stico -->
                        <div>
                            <div class="route" style="margin-top: 5px; background: white; border: 1px solid #eee;">
                                <div class="route-point">
                                    <strong>{{ alt.origem_cidade }}</strong><br>
                                    {{ alt.origem_uf }}
                                </div>
                                <div class="route-arrow">
                                    ‚ûú
                                    <span class="route-dist">{{ alt.distancia_km }}</span>
                                </div>
                                <div class="route-point">
                                    <strong>{{ alt.destino_cidade }}</strong><br>
                                    {{ alt.destino_uf }}
                                </div>
                            </div>

                            <ul class="info-list" style="margin-top: 10px;">
                                <li>
                                    <span class="label">Impacto Frete:</span>
                                    <span class="value" style="color: var(--danger-color);">{{ alt.impacto_frete
                                        }}</span>
                                </li>
                                <li>
                                    <span class="label">Situa√ß√£o Fiscal:</span>
                                    <span class="value">{{ alt.situacao_fiscal }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endif %}

            <!-- Bot√£o de impress√£o -->
            <div class="actions">
                <button class="print-btn" onclick="window.print()">Imprimir Laudo / Salvar PDF</button>
            </div>
        </div>

        <div class="footer">
            Gerado automaticamente pela plataforma CAP Price.
            Data de refer√™ncia: {{ data_referencia or '‚Äî' }}.
        </div>
    </div>

</body>

</html>